<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>system/native_array.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <script type="text/javascript" src="../../assets/scripts/vendor/jquery-1.8.3.min.js"></script>

  <script type="text/javascript" src="../../assets/scripts/vendor/lodash.min.js"></script>
  <script type="text/javascript" src="../../assets/scripts/vendor/raphael-min.js"></script>
  <script type="text/javascript" src="../../assets/scripts/vendor/morris.min.js"></script>
  <script type="text/javascript" src="../../assets/scripts/vendor/bootstrap-tooltip.js"></script>
  <script type="text/javascript" src="../../assets/scripts/vendor/bootstrap-popover.js"></script>
  <script type="text/javascript" src="../../assets/scripts/vendor/codemirror/codemirror.js"></script>
  <script type="text/javascript" src="../../assets/scripts/vendor/codemirror/util/searchcursor.js"></script>
  <script type="text/javascript" src="../../assets/scripts/vendor/codemirror/javascript.js"></script>

  <script type="text/javascript" src="report.js"></script>

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap-3.0.0-wip.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome-ie7.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="brand" href="http://github.com/jsoverson/plato">Plato on Github</a>
    <ul class="nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>system/native_array.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="span4">
      <h2 class="header">Complexity</h2>
      <p class="stat">26</p>
    </div>
    <div class="span4">
      <h2 class="header">Maintainability</h2>
      <p class="stat">119.31</p>
    </div>
    <div class="span4">
      <h2 class="header">Estimated # Bugs</h2>
      <p class="stat">1.02</p>
    </div>
  </div>
  <div class="row">
    <div class="span4">
      <h2 class="header">Difficulty</h2>
      <p class="stat">53.07</p>
    </div>
    <div class="span4">
      <h2 class="header">Volume</h2>
      <p class="stat">3054.98</p>
    </div>
    <div class="span4">
      <h2 class="header">SLOC/LSLOC</h2>
      <p class="stat">156 / 82</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="span6">
      <h3 class="chart-header">By Complexity</h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="span6">
      <h3 class="chart-header">By SLOC</h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="span12">require('ember-runtime/mixins/observable');
require('ember-runtime/mixins/mutable_array');
require('ember-runtime/mixins/copyable');

/**
@module ember
@submodule ember-runtime
*/


var get = Ember.get, set = Ember.set;

// Add Ember.Array to Array.prototype. Remove methods with native
// implementations and supply some more optimized versions of generic methods
// because they are so common.
var NativeArray = Ember.Mixin.create(Ember.MutableArray, Ember.Observable, Ember.Copyable, {

  // because length is a built-in property we need to know to just get the
  // original property.
  get: function(key) {
    if (key==='length') return this.length;
    else if ('number' === typeof key) return this[key];
    else return this._super(key);
  },

  objectAt: function(idx) {
    return this[idx];
  },

  // primitive for array support.
  replace: function(idx, amt, objects) {

    if (this.isFrozen) throw Ember.FROZEN_ERROR ;

    // if we replaced exactly the same number of items, then pass only the
    // replaced range. Otherwise, pass the full remaining array length
    // since everything has shifted
    var len = objects ? get(objects, 'length') : 0;
    this.arrayContentWillChange(idx, amt, len);

    if (!objects || objects.length === 0) {
      this.splice(idx, amt) ;
    } else {
      var args = [idx, amt].concat(objects) ;
      this.splice.apply(this,args) ;
    }

    this.arrayContentDidChange(idx, amt, len);
    return this ;
  },

  // If you ask for an unknown property, then try to collect the value
  // from member items.
  unknownProperty: function(key, value) {
    var ret;// = this.reducedProperty(key, value) ;
    if ((value !== undefined) && ret === undefined) {
      ret = this[key] = value;
    }
    return ret ;
  },

  // If browser did not implement indexOf natively, then override with
  // specialized version
  indexOf: function(object, startAt) {
    var idx, len = this.length;

    if (startAt === undefined) startAt = 0;
    else startAt = (startAt < 0) ? Math.ceil(startAt) : Math.floor(startAt);
    if (startAt < 0) startAt += len;

    for(idx=startAt;idx<len;idx++) {
      if (this[idx] === object) return idx ;
    }
    return -1;
  },

  lastIndexOf: function(object, startAt) {
    var idx, len = this.length;

    if (startAt === undefined) startAt = len-1;
    else startAt = (startAt < 0) ? Math.ceil(startAt) : Math.floor(startAt);
    if (startAt < 0) startAt += len;

    for(idx=startAt;idx>=0;idx--) {
      if (this[idx] === object) return idx ;
    }
    return -1;
  },

  copy: function(deep) {
    if (deep) {
      return this.map(function(item){ return Ember.copy(item, true); });
    }

    return this.slice();
  }
});

// Remove any methods implemented natively so we don't override them
var ignore = ['length'];
Ember.EnumerableUtils.forEach(NativeArray.keys(), function(methodName) {
  if (Array.prototype[methodName]) ignore.push(methodName);
});

if (ignore.length>0) {
  NativeArray = NativeArray.without.apply(NativeArray, ignore);
}

/**
  The NativeArray mixin contains the properties needed to to make the native
  Array support Ember.MutableArray and all of its dependent APIs. Unless you
  have `Ember.EXTEND_PROTOTYPES or `Ember.EXTEND_PROTOTYPES.Array` set to
  false, this will be applied automatically. Otherwise you can apply the mixin
  at anytime by calling `Ember.NativeArray.activate`.

  @class NativeArray
  @namespace Ember
  @extends Ember.Mixin
  @uses Ember.MutableArray
  @uses Ember.MutableEnumerable
  @uses Ember.Copyable
  @uses Ember.Freezable
*/
Ember.NativeArray = NativeArray;

/**
  Creates an `Ember.NativeArray` from an Array like object.
  Does not modify the original object.

  @method A
  @for Ember
  @return {Ember.NativeArray}
*/
Ember.A = function(arr){
  if (arr === undefined) { arr = []; }
  return Ember.Array.detect(arr) ? arr : Ember.NativeArray.apply(arr);
};

/**
  Activates the mixin on the Array.prototype if not already applied. Calling
  this method more than once is safe.

  @method activate
  @for Ember.NativeArray
  @static
  @return {void}
*/
Ember.NativeArray.activate = function() {
  NativeArray.apply(Array.prototype);

  Ember.A = function(arr) { return arr || []; };
};

if (Ember.EXTEND_PROTOTYPES === true || Ember.EXTEND_PROTOTYPES.Array) {
  Ember.NativeArray.activate();
}

</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-notice-template">
<div class="complexity-notice">
  Complexity : {{ complexity.cyclomatic }} <br>
  Length : {{ complexity.halstead.length }} <br>
  Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
  Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
</div>
</script>
<script>
  function focusFragment() {
    $('.plato-mark').removeClass('focus');
    var markId = window.location.hash.substr(1);
    if (markId) $('.' + markId).addClass('focus');
  }

  $(focusFragment)
  window.onhashchange = function(){
    focusFragment();
  }

  var srcEl = document.getElementById('file-source');
  var options = {
    lineNumbers : true,
    gutters     : ['plato-gutter'],
    readOnly    : 'nocursor'
  };
  var cm = CodeMirror.fromTextArea(srcEl, options);

  var byComplexity = _.map(__report.functions,function(fn,i){
    return {
      label : fn.name,
      value : fn.complexity.cyclomatic
    }
  })

  var bySloc = _.map(__report.functions,function(fn,i){
    return {
      label : fn.name,
      value : fn.complexity.sloc.physical,
      formatter: function (x) { return x + " lines"}
    }
  })

  var scrollToLine = function(i, data) {
    var origScroll = [window.pageXOffset,window.pageYOffset];
    window.location.hash = '#plato-mark-fn-' + i;
    window.scrollTo(origScroll[0],origScroll[1]);
    var line = __report.functions[i].line;
    var coords = cm.charCoords({line : line, ch : 0});
    $('body,html').animate({scrollTop : coords.top -50},250)
  };

  Morris.Donut({
    element: 'fn-by-complexity',
    data: byComplexity
  }).on('click',scrollToLine);
  Morris.Donut({
    element: 'fn-by-sloc',
    data: bySloc
  }).on('click',scrollToLine);


  __report.functions.forEach(function (fn,i) {
    var name = fn.name === '<anonymous>' ? 'function\\s*\\([^)]*\\)' : fn.name;
    var line = fn.line - 1;
    var re = new RegExp('(' + name + ')', 'g');
    var cursor = cm.getSearchCursor(re, {line : line, ch : 0});
    var match;
    _.templateSettings = {
      interpolate : /\{\{(.+?)\}\}/g
    };
    var notice = _.template($('#complexity-notice-template').text());
//    cm.addLineWidget(line, $(notice(fn))[0], {});

    while (match = cursor.findNext()) {
      if (cursor.to().line !== line) break;
      cm.markText(
        { line : line, ch : cursor.from().ch },
        { line : line, ch : cursor.to().ch },
        {
          className   : 'plato-mark plato-mark-fn-' + i,
          startStyle  : 'plato-mark-start',
          endStyle    : 'plato-mark-end'
        }
      )
    }
    var gutterIcon = $('<a class="plato-gutter-complexity" name="' + ('plato-mark-fn-'+i) + '"><i class="icon-cog"></i></a>');
    cm.setGutterMarker(line, 'plato-gutter', gutterIcon[0])
    var stillIn = false;
    var markStart = $('.plato-mark-start.plato-mark-fn-' + i);
    var markSpans = $('.plato-mark-fn-' + i);

    markSpans.add(gutterIcon)
      .on('mouseenter touchstart',function(e){
        e.preventDefault();
        e.stopPropagation();
        markSpans.addClass('active');
        stillIn = true;
        markStart.popover('show');
      })
      .on('mouseleave touchend',function(e){
        e.preventDefault();
        e.stopPropagation();
        markSpans.removeClass('active');
        stillIn = false;
        setTimeout(function(){
          if (!stillIn) markStart.popover('hide');
        },200);
      });

    markStart.popover({
      trigger : 'manual',
      content : notice(fn),
      html : true,
      title : fn.name === '<anonymous>' ? '&lt;anonymous&gt;' : 'function ' + fn.name + '',
      placement : 'top'
    })

  })

</script>
</body>
</html>
